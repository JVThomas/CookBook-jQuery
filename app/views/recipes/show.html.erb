<div>
  <h1><%= @recipe.name%></h1>
  <h3>By: <%=link_to "#{@recipe.user_name}", user_path(@recipe.user)%></h3>

  <h3>Instructions:</h3>
  <h4><%=@recipe.content%></h4>

  <h3>Ingredients</h3>

  <%@recipe.recipe_ingredients.each do |recipe_ingredient|%>
      <h4><%=recipe_ingredient.ingredient_name %>: <%=recipe_ingredient.quantity%></h4>
  <%end%>

  <% if @recipe.user == current_user%>
    <%= link_to "Edit Recipe", edit_user_recipe_path(current_user,@recipe), class: "btn"%>
    <%= link_to "Delete Recipe", user_recipe_path(current_user, @recipe), method: :delete, class: "btn"%>
  <%end%>
</div>

<h1>Comments</h1>
<div id = "commentsList">
  <% @recipe.comments.each do |comment| %>
  <div id = "comment-<%=comment.id%>">
    <h3> <%= comment.user_name %> Says: </h3>
    <h4> <%= comment.content %> </h4>
    <%if comment.user == current_user%>
      <%= link_to "Edit Comment", edit_user_comment_path(comment.user, comment), class: "btn"%>
      <a href = "#" class = "btn deleteLink" data-id="<%=comment.id%>" data-user-id="<%=comment.user.id%>">Delete Comment</a>
    <%end%>
  </div>
  <%end%>
</div>

<div>
  <%if logged_in?%>
  <h3>Leave A Comment</h3>
    <%=render 'comments/comment'%>
  <%end%>
</div>

<script type="text/javascript" charset= "utf-8">
  $(document).ready(function(){
    $('#new_comment').on("submit",function(event){
      event.preventDefault();
      posted_comment = $(this).serialize();
      $.post('/comments',posted_comment).done(function(data){
        var commentUser = data["comment"]["user"]
        var commentContent = data["comment"]["content"];
        var commentId = data["comment"]["id"];
        var injectText = '<div id = "comment-' + commentId + '">';
        injectText +='<h3> ' + commentUser["name"] + " Says: </h3>";
        injectText +='<h4> ' + commentContent + " </h4>";
        injectText +='<a href = "/users/' + commentUser["id"] +'/comments/'+ commentId+'/edit" class = "btn">Edit Comment</a>';
        injectText +='<a href = "#" class = "btn deleteLink" data-id = "' + commentId + '" data-user-id="' + commentUser["id"] + '">Delete Comment</a></div>';
        $('#commentsList').append(injectText);
        $('#commentsList div:last').hide().fadeIn("slow");
      }).fail(function(error){
        alert("Content must be filled in");
      });
    });
    
    $('#commentsList').on("click",'.deleteLink',function(event){
      event.preventDefault();
      var deleteUrl = '/comments/' + $(this).data("id");
      var parentDiv = $(this).parent();
      $.ajax({
        url: deleteUrl,
        type: "POST",
        data:{"_method": "DELETE"}
      }).done(function(data){
        $(parentDiv).fadeOut("slow");
      }).fail(function(error){
        alert(error.statusText);
      });
    });

  });
</script>

